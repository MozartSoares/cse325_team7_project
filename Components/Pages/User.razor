@page "/user/{id?}"
@rendermode InteractiveServer
@using cse325_team7_project.Api.DTOs
@using cse325_team7_project.Components.Services
@using cse325_team7_project.Domain.Enums
@implements IDisposable
@inject HttpClient HttpClient
@inject NavigationManager Nav
@inject AuthStateService AuthState

<PageTitle>@pageTitle</PageTitle>

<div class="user-detail-container">
    <h1>Profile Details</h1>

    @*
        Displays a loading message if user data is not yet loaded.
        Otherwise, renders the user's profile details.
    *@
    @if (userData == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="user-info-grid">
            <!-- Displays the first letter of the username as a profile initial -->
            <div class="profile-circle">@GetInitial(userData.Name)</div>


            <!-- Displays user details in a definition list -->
            <div class="user-details">
                <dl>
                    <dt>Username:</dt>
                    <dd>@userData.Username</dd>

                    <dt>Name:</dt>
                    <dd>@userData.Name</dd>

                    <dt>Email:</dt>
                    <dd>@userData.Email</dd>

                    @if (IsAdmin)
                    {
                    <dt>Role:</dt>
                    <dd>@userData.Role</dd>
                    }
                    <dt>Created At:</dt>
                    <dd>@userData.CreatedAt.ToString("g")</dd>

                    <dt>Updated At:</dt>
                    <dd>@userData.UpdatedAt.ToString("g")</dd>
                </dl>
            </div>

            <!-- Action buttons for editing and deleting the profile -->
            @if (CanManageProfile)
            {
                <div class="action-buttons">
                    <button class="edit-button" @onclick="ShowUserModal">Edit</button>
                    <button class="delete-button" @onclick="ShowDeleteModal">Delete</button>
                </div>
            }
        </div>

        @if (IsAdmin)
        {
            <div class="admin-actions">
                <button class="edit-button" @onclick="ShowAdminRegisterModal">Create Admin User</button>
                @if (!string.IsNullOrWhiteSpace(adminRegistrationSuccessMessage))
                {
                    <span class="success-message">@adminRegistrationSuccessMessage</span>
                }
            </div>
        }

        <!-- Section for displaying the user's movie lists -->
        <div class="list-header-container">
            <h2>Lists</h2>
            @if (CanAddList)
            {
                <button class="edit-button" @onclick="ShowAddModal">Add List</button>
            }
        </div>


        @*
            Checks if the user has any lists.
            If yes, renders a MovieListCollection component for each list.
            If no, displays a message indicating no lists are available.
        *@
        @if (userData.Lists != null && userData.Lists.Any())
        {
            foreach (var list in userData.Lists)
            {
                <MovieListCollection movieListId=@list OnDeleted="HandleListDeleted" />
            }
        }
        else
        {
            <p>No lists available for this user.</p>
        }

        @if (CanManageProfile)
        {
            <Modal Title="Edit Profile" Show="@userModalVisible" OnDecline="CloseUserModal">
                @if (userUpdateDto != null)
                {
                    <EditForm EditContext="@editContext" OnValidSubmit="HandleUserEditSubmit">
                        <DataAnnotationsValidator />

                        <div class="form-group">
                            <label>Name</label>
                            <InputText @bind-Value="userUpdateDto.Name" class="form-control" />
                            <ValidationMessage For="@(() => userUpdateDto.Name)" />
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <InputText @bind-Value="userUpdateDto.Email" class="form-control" />
                            <ValidationMessage For="@(() => userUpdateDto.Email)" />
                        </div>
                        <button type="submit" class="btn btn-primary" disabled="@isChanged">Save</button>
                    </EditForm>
                }
            </Modal>

            <Modal Title="Confirm" AcceptText="Confirm" Show="@deleteModalVisible" OnDecline="CloseDeleteModal"
                OnAccept="HandleDeleteSubmit">
                <p>Do you want to delete your account?</p>
            </Modal>
        }

        @if (CanAddList)
        {
            <Modal Title="Add List" Show="@addListModalVisible" OnDecline="CloseAddModal">
                <EditForm Model="@newMovieList" OnValidSubmit="HandleAddListSubmit">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Title</label>
                        <InputText @bind-Value="newMovieList.Title" class="form-control" />
                        <ValidationMessage For="@(() => newMovieList.Title)" />
                    </div>
                    <button type="submit" class="btn btn-primary">Create</button>
                </EditForm>
            </Modal>
        }

        <RegisterModal Show="@adminRegisterModalVisible"
                       OnClose="CloseAdminRegisterModal"
                       OnRegistrationSuccess="HandleAdminRegistrationSuccess"
                       Title="Create admin account"
                       SubmitButtonText="Create admin"
                       SubmittingButtonText="Creating admin..."
                       ShowLoginSwitch="false"
                       UseAdminCreationFlow="true" />
    }
</div>

@code {
    /// <summary>
    /// Gets or sets the user ID from the route parameter.
    /// </summary>
    /// <value>
    /// The unique identifier for the user, passed as a route parameter.
    /// </value>
    [Parameter]
    public string? id { get; set; }

    /// <summary>
    /// Stores the user data fetched from the API.
    /// </summary>
    private UserResponseDto? userData;
    private UserUpdateDto? userUpdateDto;

    private EditContext? editContext;
    private bool isChanged = true;

    private MoviesListCreateDto newMovieList = new();
    private bool adminRegisterModalVisible;
    private string? adminRegistrationSuccessMessage;
    private string pageTitle = "Profile";

    private bool IsAdmin => AuthState.CurrentUser?.Role == UserRole.Admin;
    private bool IsSelf => AuthState.CurrentUser?.Id == userData?.Id;
    private bool CanManageProfile => IsAdmin || IsSelf;
    private bool CanAddList => AuthState.IsAuthenticated && IsSelf;

    private void HandleListDeleted(string id)
    {
        if (userData?.Lists is null)
        {
            return;
        }

        // Remove the list id locally to update UI instantly
        userData = userData with { Lists = userData.Lists.Where(x => x != id).ToList() };
        _ = InvokeAsync(StateHasChanged);
    }

    protected override void OnInitialized()
    {
        AuthState.AuthStateChanged += HandleAuthStateChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await AuthState.EnsureInitializedAsync();
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            var targetId = id;
            if (string.IsNullOrWhiteSpace(targetId))
            {
                targetId = AuthState.CurrentUser?.Id;
            }

            if (!string.IsNullOrWhiteSpace(targetId))
            {
                // Fetch user data from the API using the provided ID
                userData = await HttpClient.GetFromJsonAsync<UserResponseDto>(Nav.ToAbsoluteUri($"api/users/{targetId}"));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user from API: {ex.Message}");
        }
        if (userData != null)
        {
            userUpdateDto = new UserUpdateDto { Name = userData.Name, Email = userData.Email };
            editContext = new EditContext(userUpdateDto);
            editContext.OnFieldChanged += (sender, eventArgs) => isChanged = false;
            pageTitle = FormatProfileTitle(userData);
        }
        else
        {
            pageTitle = "Profile Not Found";
        }
    }

    /// <summary>
    /// Extracts the first character of a username to use as a profile initial.
    /// </summary>
    /// <param name="username">The username to extract the initial from.</param>
    /// <returns>
    /// The first character of the username as an uppercase string,
    /// or an empty string if the username is null or whitespace.
    /// </returns>
    private string GetInitial(string username)
    {
        return string.IsNullOrWhiteSpace(username) ? string.Empty : username[0].ToString().ToUpper();
    }

    @* User Edit Form *@
    private bool userModalVisible = false;
    private void ShowUserModal()
    {
        if (!CanManageProfile)
        {
            return;
        }

        userModalVisible = true;
    }
    private void CloseUserModal() => userModalVisible = false;

    private async Task HandleUserEditSubmit()
    {
        if (!CanManageProfile)
        {
            CloseUserModal();
            return;
        }

        try
        {
            Console.WriteLine($"Updating user {userData?.Name}");
            if (!await AuthState.ApplyAuthorizationAsync(HttpClient))
            {
                Console.WriteLine("Not authenticated; cannot update user.");
                CloseUserModal();
                return;
            }
            var response = await HttpClient.PutAsJsonAsync(Nav.ToAbsoluteUri($"api/users/{userData?.Id}"), userUpdateDto);

            if (response.IsSuccessStatusCode)
            {
                userData = await response.Content.ReadFromJsonAsync<UserResponseDto>();
                if (IsSelf && userData is not null)
                {
                    await AuthState.UpdateUserAsync(userData);
                }
                if (userData is not null)
                {
                    pageTitle = FormatProfileTitle(userData);
                }
                CloseUserModal();
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error updating user: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    @* User Delete Confirm *@
    private bool deleteModalVisible = false;
    private void ShowDeleteModal()
    {
        if (!CanManageProfile)
        {
            return;
        }

        deleteModalVisible = true;
    }
    private void CloseDeleteModal() => deleteModalVisible = false;

    private async Task HandleDeleteSubmit()
    {
        if (!CanManageProfile)
        {
            CloseDeleteModal();
            return;
        }

        try
        {
            Console.WriteLine($"Deleting user {userData?.Name}");
            if (!await AuthState.ApplyAuthorizationAsync(HttpClient))
            {
                Console.WriteLine("Not authenticated; cannot delete user.");
                CloseDeleteModal();
                return;
            }
            var response = await HttpClient.DeleteAsync(Nav.ToAbsoluteUri($"api/users/{userData?.Id}"));

            if (response.IsSuccessStatusCode)
            {
                Nav.NavigateTo("/");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error deleting user: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            CloseDeleteModal();
        }
    }


    @* Add List Form *@
    private bool addListModalVisible = false;
    private void ShowAddModal()
    {
        if (!CanAddList)
        {
            return;
        }

        addListModalVisible = true;
    }
    private void CloseAddModal()
    {
        addListModalVisible = false;
        newMovieList = new MoviesListCreateDto();
    }

    private async Task HandleAddListSubmit()
    {
        if (!await AuthState.ApplyAuthorizationAsync(HttpClient))
        {
            Console.WriteLine("Error: You must be logged in to create a list.");
            CloseAddModal();
            return;
        }

        if (!CanAddList)
        {
            Console.WriteLine("Error: You can only create lists for your own profile.");
            CloseAddModal();
            return;
        }

        try
        {
            var response = await HttpClient.PostAsJsonAsync(Nav.ToAbsoluteUri("api/lists/"), newMovieList);

            if (response.IsSuccessStatusCode)
            {
                CloseAddModal();
                
                // Reload user data to reflect the new list
                await LoadUserData();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error adding list: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void ShowAdminRegisterModal()
    {
        adminRegistrationSuccessMessage = null;
        adminRegisterModalVisible = true;
    }

    private void CloseAdminRegisterModal()
    {
        adminRegisterModalVisible = false;
    }

    private async Task HandleAdminRegistrationSuccess()
    {
        adminRegistrationSuccessMessage = "Admin account created successfully.";
        await InvokeAsync(StateHasChanged);
    }

    private void HandleAuthStateChanged()
    {
        if (!IsAdmin)
        {
            adminRegisterModalVisible = false;
            adminRegistrationSuccessMessage = null;
        }
        pageTitle = FormatProfileTitle(userData);
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthState.AuthStateChanged -= HandleAuthStateChanged;
    }

    private static string FormatProfileTitle(UserResponseDto? user)
    {
        if (user is null) return "Profile";
        var nameOrUsername = string.IsNullOrWhiteSpace(user.Name) ? user.Username : user.Name;
        return string.IsNullOrWhiteSpace(nameOrUsername) ? "Profile" : $"{nameOrUsername}'s Profile";
    }
}
